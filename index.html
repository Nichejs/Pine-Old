<html>
<head>
<title>Open RPG</title>
<style type="text/css">
	body{
		margin:0;
		padding: 0;
	}
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
	$(document).ready(function(e) {
	// VARIABLES
		var ctx;
		var WIDTH;
		var HEIGHT;
		
		var canvasMinX;
		var canvasMaxX;
		
		var canvasMinY;
		var canvasMaxY;
		
		var rotation = 0; // Angulo de giro
		
		var ms = {x:0, y:0}; // Mouse speed
		var mp = {x:0, y:0}; // Mouse position
		
		var fps = 0, now, lastUpdate = (new Date)*1 - 1;
		var fpsFilter = 100;
		
		ctx = $('#bg')[0].getContext("2d");
		
		
		// Actualizamos las variables:
		WIDTH = $("#container").width();
	  	HEIGHT = $("#container").height();
		
		canvasMinX = $("#container").offset().left;
	  	canvasMaxX = canvasMinX + WIDTH;
		
		canvasMinY = $("#container").offset().top;
	  	canvasMaxY = canvasMinY + HEIGHT;
	  	
	  	$("#bg").attr('width',WIDTH);
		$("#bg").attr('height',HEIGHT);
		
		
		/*// Isometric
	    ctx.translate(WIDTH/2, 0);
	    ctx.scale(1, 0.5);
	    ctx.rotate(45 * Math.PI /180);*/
	  	
	  	
	  	//ctx.translate(0,HEIGHT/2);
	  	
		// Funciones importantes:
		function clear() {
			ctx.clearRect(0, 0, WIDTH, HEIGHT);
		}
		
		function circle(x,y,rad,color){
			// Circulo
			ctx.fillStyle = color;
			ctx.beginPath();
			ctx.arc(x,y,rad,0,Math.PI*2,true);
			ctx.closePath();
			ctx.fill();
		}
		
		function fade() {
			ctx.fillStyle="rgba(0,0,0,0.01)";
			ctx.fillRect(0, 0, WIDTH, HEIGHT);
		}
		
		function resizeCanvas(e) {
			/*WIDTH = window.innerWidth;
			HEIGHT = window.innerHeight;
			
			$("#bg").attr('width',WIDTH);
			$("#bg").attr('height',HEIGHT);
			
			ctx.translate(0,HEIGHT/2);*/
		}
		
		function mouseMove(e) {
			ms.x = Math.max( Math.min( e.pageX - mp.x, 40 ), -40 );
			ms.y = Math.max( Math.min( e.pageY - mp.y, 40 ), -40 );
			
			mp.x = e.pageX - canvasMinX;
			mp.y = e.pageY - canvasMinY;
		}
		var points = 100;
		var t = 0;
		// Move 0,0 to the center of the screen
		function draw(e) {
			ctx.fillStyle = "rgba(200,200,200,1)";
			ctx.fillRect(0, 0, WIDTH, HEIGHT);
			
			drawSector();
		}
		
		// Draw a new sector of the map
		function drawSector(){
			/* Este array se recibiria normalmente por parametro
			   generado a su vez por el servidor, pero de momento
			   lo inserto a mano.
			 */
			// Es un objeto, de tipo sector
			// Lo siguiente son las caracteristicas
			// el tipo define el suelo predominante. Si eso... 
			
			// Las coordenadas del canvas van del 0,0 arriba a la izquierda hacia abajo
			// x es normal, y crece hacia abajo.....
			
			var sector = {
				pos		: {x:0, y:0},
				type	: 0,
				geography : [
					{
						pos : {x:4, y:2},
					 	type : 'water'
					 },
					{
						pos : {x:8, y:4},
						type : 'gold'
					}
				],
				objects : [
					{
						pos : {x:17, y:8},
						type : 'tree'
					},
					{
						pos : {x:7,y:10},
						type : 'tree'
					}
				]
			};
			
			// Esto deberia estar en otro lugar declarado, o en una base de datos
			var objects = {
				tree : {
					width : 20,
					height : 60,
					color : "rgba(255,75,20,1)"
				}
			};
			
			// Draw the received data. Supposing sectors of 20x20px (They will be larger)
			// Fill background with main type color
			var style = {
					water : "rgba(50,50,255,1)",
					gold : "rgba(200,200,10,1)",
					normal : "rgba(100,255,100,1)"
				};
			// Luego habra que recolocar TODAS las variables...
			var sectorSize = 20,
				blockSize = 20;
			// Pinta el fondo del color/textura principal
			ctx.fillStyle = style['normal'];
			console.log(style.normal);
			ctx.fillRect(0, 0, sectorSize*blockSize, sectorSize*blockSize);
			// Coloca la geografia
			for(var i=0;i<sector.geography.length;i++){
				console.log(sector.geography[i]);
				ctx.fillStyle = style[sector.geography[i].type];
				ctx.fillRect(sector.geography[i].pos.x*blockSize, sector.geography[i].pos.y*blockSize, blockSize, blockSize);
			}
			
			// Coloca los objetos
			for(var i=0;i<sector.objects.length;i++){
				console.log(sector.geography[i]);
				var current = objects[sector.objects[i].type];
				ctx.fillStyle = current.color;
				ctx.fillRect(sector.objects[i].pos.x*blockSize, sector.objects[i].pos.y*blockSize, current.width, current.height);
			}
		}
		
		function frame(){
			clear();
			draw();
			// Now calculate FPS
			var thisFrameFPS = 1000 / ((now=new Date) - lastUpdate);
			fps += (thisFrameFPS - fps) / fpsFilter;
			lastUpdate = now * 1 - 1;
		}
		
		// Display fps
		setInterval(function(){ $('#fps').text('FPS: '+fps.toFixed(0)); }, 500); 
		
		// Actualizadores
		resizeCanvas();
		$(window).resize(resizeCanvas);
		$(document).mousemove(mouseMove);
		//drawInterval = setInterval( frame, 1 );
		draw();
	});
</script>
</head>
<body>
	<h1>Open RPG</h1>
	<p>Esto es el archivo index.html</p>
	<div id="container" style="border:1px solid #ccc; width: 600px; height:500px; margin:0 auto;">
		<canvas id="bg"></canvas>
	</div>
</body>
</html>